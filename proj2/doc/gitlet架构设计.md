# gitlet架构设计

[TOC]

---

## 1. 核心功能

gitlet可以为当前工作目录中**指定的文件生成一份快照**，并打上对应的信息，并在未来任意时刻**恢复先前存档过的快照中的文件及其内容**。

**围绕“快照”**，gitlet提供了一套**“增删改查”**的机制。对于getlet而言，已经提交的快照是不可更改的(immutable)，“即将提交的快照”被称为暂存区，而暂存区中的文件是可以更改的，gitlet提供了修改暂存区文件的方法。

gitlet不仅提供了一套单机的文件快照管理的解决方案，还提供了多人协作情况下的文件管理。通过“**分支-合并”**机制，gitlet可以针对同一份目录，分别为不同用户生成各自的文件快照，每个用户都在自己的分支上工作，并在需要的时候进行合并，进而更新整个目录中的文件状态。

---

## 2. gitlet工作流示意

![](./pic/structure-workflow.jpg)

以给定“单一分支”的条件为例，gitlet的一个典型的工作流是：

1. 初始化

   - 用户**初始化(init)**一个仓库(repository)，仓库用于存放gitlet的元信息，包括但不限于历史commit，追踪的文件信息，分支等等；

2. 生成并提交快照

   - 用户将需要被快照保存的文件**加入(add)**暂存区(staging area)；

   - 用户将当前暂存区中的文件永久保存，生成一个**快照(commit)**，快照包含自己的唯一标识id，被记录的文件名以及文件内容，提交时间，用户提供的快照信息(commit message)等；

3. 回滚

   - 用户通过查看**日志(log)**的方式，来查看当前分支中提交的历史快照，并选择其中的一个**检出(checkout)**到当前工作目录(working directory)；

---

## 3. 领域对象

### 3.1 工作目录(Working directory)

“工作目录”是一个目录(文件夹)，也是gitlet**用于追踪和记录文件快照的全局环境**。在gitlet初始化后，工作目录的文件可以被gitlet加入、移除、查询不同版本中的内容，但不能更改历史提交中的内容。

### 3.2 仓库(Repository)

“仓库”是gitlet**本身工作的目录**，它应该对工作目录不可见(隐藏抽象)，同时为gitlet的正确运行和管理提供能力。gitlet会将暂存区、历史commit等数据持久化在这个目录内。

### 3.3 提交(commit)

“提交”作为一个名词，指的是一系列文件及其提交时的内容的快照，快照是给定文件在给定时刻下的所有内容的状态。这里“给定文件”由暂存区内的文件来确定，“给定时刻”由用户执行提交操作时的时间确定。

### 3.4 暂存区(Staging Area)

“暂存区”用于“暂时存放”工作目录中待提交的文件，具体来说，用户生成一个文件的快照的流程大体上可以分为两步：第一步将目标文件加入到暂存区中，第二步将文件提交。这里的提交，事实上是将暂存区中所有文件及其对应内容生成一个提交时刻的快照。

### 3.5 分支(Branch)

“分支”是组织和串联“提交”的一种抽象结构，一个分支可以对应一系列的提交，同时一个提交可以位于多个分支当中，可以认为分支是有向图中的一条路径。

分支最大的意义就是赋予了多人协作修改文件内容并记录快照的可能性。gitlet提供了`merge`操作，使得当不同的用户对同一份文件做出了不同的修改，同时保存了不同的快照，并在将来的某个时间点想要合并彼此的修改记录和追踪的一系列快照的话，分支可以在这其中扮演正确梳理和合并记录的重要依据。

### 3.6 单文件快照(staged content)

某个确定时刻下，一个文件的内容可以用来表示这个文件的状态，当我们要保存这个状态时，我们就说对单个文件进行了“快照(snapshot)”操作。一个文件的快照应该包括这个文件的内容、文件名、以及对应的唯一索引方式。

---

## 4. 实体

### 4.1 Blob

Blob是给定文件在给定时刻下的**状态的抽象**，一个Blob对象应该至少包括这些成员：

- id {String} blob对象的id，用于唯一标识一个blob对象，采用sha1 hash进行编码；
- content {String} blob对象对应文件的内容；

### 4.2 Stagingrea

StagingArea对应业务对象中的“暂存区”的概念，其至少需要包括：

- fileName {String} add进入的文件的文件名；
- fileBlob {String} 文件名对应的Blob；

### 4.4 Commit

对应业务对象中的“Commit”，其至少需要包括：

- id {String} Commit对象的id，用于唯一标识一个Commit对象，采用sha1 hash进行编码；
- stagedFiles {StagedArea} 文件及其Blob的快照；

### 4.3 Tree

对应Commit的历史以及分支，其至少需要包括：

- 